<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Busca Legislativo SP</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos customizados para o Slider (Range) */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
            touch-action: pan-y;
            /* TRUQUE CSS: O slider em si não recebe cliques (permite rolar a tela) */
            pointer-events: none;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            /* TRUQUE CSS: Apenas a bolinha recebe cliques/arraste */
            pointer-events: auto;
            
            /* Aumentado para 36px para facilitar o toque preciso */
            height: 36px;
            width: 36px;
            border-radius: 50%;
            background: #2563EB;
            cursor: grab;
            margin-top: -15px; /* Ajuste para centralizar (36px) */
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            border: 3px solid white;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #E2E8F0;
            border-radius: 3px;
        }

        /* Suporte para Firefox */
        input[type=range]::-moz-range-thumb {
            pointer-events: auto;
            height: 36px;
            width: 36px;
            border-radius: 50%;
            background: #2563EB;
            cursor: grab;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            border: 3px solid white;
        }

        .touch-action-manipulation {
            touch-action: manipulation;
        }

        .mode-btn-active {
            background-color: #2563EB; /* blue-600 */
            color: white;
            border-color: #2563EB;
        }
        .mode-btn-inactive {
            background-color: white;
            color: #4B5563; /* gray-600 */
            border-color: #E5E7EB; /* gray-200 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col items-center justify-start p-4">

    <!-- Seletor de Modo (Abas) -->
    <div class="w-full max-w-md grid grid-cols-2 gap-0 mb-2 mt-2">
        <button onclick="setMode('projetos')" id="tab-projetos" class="py-3 font-bold text-sm rounded-l-2xl border border-r-0 transition-all touch-action-manipulation mode-btn-active">
            Projetos
        </button>
        <button onclick="setMode('normas')" id="tab-normas" class="py-3 font-bold text-sm rounded-r-2xl border border-l-0 transition-all touch-action-manipulation mode-btn-inactive">
            Normas
        </button>
    </div>

    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-4 space-y-4">
        
        <!-- Seção 1: Tipo -->
        <div>
            <label class="block text-sm font-medium text-gray-500 mb-2">Tipo</label>
            <!-- Container Botões Projetos -->
            <div id="types-projetos" class="grid grid-cols-4 gap-2">
                <button onclick="selectType('PL')" id="btn-PL" class="type-btn active-type py-3 rounded-lg font-bold text-sm border transition-all duration-200 shadow-sm touch-action-manipulation">PL</button>
                <button onclick="selectType('PDL')" id="btn-PDL" class="type-btn py-3 rounded-lg font-bold text-sm border transition-all duration-200 shadow-sm touch-action-manipulation">PDL</button>
                <button onclick="selectType('PR')" id="btn-PR" class="type-btn py-3 rounded-lg font-bold text-sm border transition-all duration-200 shadow-sm touch-action-manipulation">PR</button>
                <button onclick="selectType('PLO')" id="btn-PLO" class="type-btn py-3 rounded-lg font-bold text-sm border transition-all duration-200 shadow-sm touch-action-manipulation">PLO</button>
            </div>
            <!-- Container Botões Normas -->
            <div id="types-normas" class="hidden grid grid-cols-4 gap-2">
                <button onclick="selectType('Lei')" id="btn-Lei" class="type-btn py-3 rounded-lg font-bold text-sm border transition-all duration-200 shadow-sm touch-action-manipulation">Lei</button>
                <button onclick="selectType('Decreto')" id="btn-Decreto" class="type-btn py-3 rounded-lg font-bold text-sm border transition-all duration-200 shadow-sm touch-action-manipulation">Decreto</button>
                <button onclick="selectType('DecLeg')" id="btn-DecLeg" class="type-btn py-3 rounded-lg font-bold text-sm border transition-all duration-200 shadow-sm touch-action-manipulation">Dec. Leg.</button>
                <button onclick="selectType('Ato')" id="btn-Ato" class="type-btn py-3 rounded-lg font-bold text-sm border transition-all duration-200 shadow-sm touch-action-manipulation">Ato</button>
            </div>
        </div>

        <!-- Seção 2: Ano (Slider + Botões) -->
        <div>
            <div class="flex justify-between items-end mb-2">
                <label class="text-sm font-medium text-gray-500">Ano</label>
                <span id="yearDisplay" class="text-2xl font-bold text-blue-600">...</span>
            </div>
            <div class="relative w-full h-10 flex items-center">
                <input type="range" id="yearSlider" class="w-full">
            </div>
            <!-- Botões Granulares de Ano (substituindo os labels de limite) -->
            <div class="flex justify-between items-center mt-1">
                <button onclick="adjustYear(-1)" class="w-10 h-10 flex items-center justify-center text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-full active:scale-90 transition-transform touch-action-manipulation font-bold text-xl">
                    −
                </button>
                <button onclick="adjustYear(1)" class="w-10 h-10 flex items-center justify-center text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-full active:scale-90 transition-transform touch-action-manipulation font-bold text-xl">
                    +
                </button>
            </div>
        </div>

        <!-- Seção 3: Número (Input + Botões + Sliders) -->
        <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
            <label class="block text-xs uppercase font-bold text-gray-400 mb-2 tracking-wider">Número</label>
            
            <!-- Display/Input Principal com Botões Granulares -->
            <div class="relative flex items-center mb-4">
                <!-- Botão Menos -->
                <button onclick="adjustNumber(-1)" class="absolute left-2 w-12 h-12 flex items-center justify-center text-blue-600 hover:bg-blue-100 rounded-full active:scale-90 transition-transform z-10 touch-action-manipulation font-bold text-2xl pb-1">
                    −
                </button>
                
                <input type="tel" id="projectNumber" pattern="[0-9]*" inputmode="numeric" placeholder="0" 
                    class="w-full text-center text-4xl font-black py-2 px-14 bg-white border border-gray-200 rounded-lg focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all text-blue-700 shadow-sm">
                
                <!-- Botão Mais -->
                <button onclick="adjustNumber(1)" class="absolute right-2 w-12 h-12 flex items-center justify-center text-blue-600 hover:bg-blue-100 rounded-full active:scale-90 transition-transform z-10 touch-action-manipulation font-bold text-2xl pb-1">
                    +
                </button>
            </div>

            <!-- Sistema de Sliders -->
            <div class="space-y-4">
                <!-- Slider Macro (Centenas ou Milhares) -->
                <div>
                    <div class="flex justify-between text-xs text-gray-400 mb-1 px-1">
                        <span>0</span>
                        <span id="label-macro" class="font-bold text-blue-500">Centenas</span>
                        <span id="max-macro-display">2000</span>
                    </div>
                    <input type="range" id="sliderMacro" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>

                <!-- Slider Mid (Centenas para Normas) - Oculto por padrão -->
                <div id="container-mid" class="hidden">
                    <div class="flex justify-between text-xs text-gray-400 mb-1 px-1">
                        <span>0</span>
                        <span class="font-bold text-blue-500">Centenas</span>
                        <span>900</span>
                    </div>
                    <!-- Range 0-9 para representar 0-900 -->
                    <input type="range" id="sliderMid" min="0" max="9" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>

                <!-- Slider Micro (Unidades) -->
                <div>
                    <div class="flex justify-between text-xs text-gray-400 mb-1 px-1">
                        <span>0</span>
                        <span id="label-micro" class="font-bold text-blue-500">Unidades</span>
                        <span id="max-micro-display">99</span>
                    </div>
                    <input type="range" id="sliderMicro" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
        </div>

        <!-- Mensagem de Erro -->
        <div id="errorMsg" class="hidden text-center text-red-500 text-sm font-medium bg-red-50 p-2 rounded-lg">
            Por favor, selecione ou digite o número.
        </div>

        <!-- Seção 4: Botões de Ação -->
        <div class="grid grid-cols-1 gap-3 pt-2">
            <!-- Botões Projetos -->
            <div id="actions-projetos" class="grid gap-3">
                <button onclick="openUrl('splegis')" class="w-full bg-emerald-600 hover:bg-emerald-700 active:bg-emerald-800 text-white font-bold py-4 rounded-xl shadow-lg transform active:scale-[0.98] transition-all flex items-center justify-center gap-2 touch-action-manipulation">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Abrir no SPLegis
                </button>
                <button onclick="openUrl('portal')" class="w-full bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold py-4 rounded-xl shadow-lg transform active:scale-[0.98] transition-all flex items-center justify-center gap-2 touch-action-manipulation">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                    </svg>
                    Abrir no Portal
                </button>
            </div>

            <!-- Botões Normas -->
            <div id="actions-normas" class="hidden grid gap-3">
                <button onclick="openUrl('plp')" class="w-full bg-purple-600 hover:bg-purple-700 active:bg-purple-800 text-white font-bold py-4 rounded-xl shadow-lg transform active:scale-[0.98] transition-all flex items-center justify-center gap-2 touch-action-manipulation">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                    Abrir no PLP
                </button>
            </div>
        </div>

    </div>

    <script>
        // =========================================================
        //  CONFIGURAÇÃO
        // =========================================================
        const CONFIG = {
            defaultYear: 2025,
            maxYear: 2026,
            projetos: {
                minYear: 1991,
                maxNumber: 2000,
                defaultNumber: '',
                hasMid: false, // Só usa 2 sliders
                macroStep: 100,
                macroLabel: 'Centenas',
                microMax: 99
            },
            normas: {
                minYear: 1980,
                maxNumber: 70000,
                defaultNumber: '18000',
                hasMid: true, // Usa 3 sliders
                macroStep: 1000,
                macroLabel: 'Milhares',
                microMax: 99
            }
        };

        let state = {
            mode: 'projetos', // 'projetos' ou 'normas'
            type: 'PL',
            number: '',
            year: CONFIG.defaultYear
        };

        const spLegisCodes = { 'PL': 1, 'PDL': 2, 'PR': 3, 'PLO': 4 };
        const plpCodes = { 'Lei': 'Lei', 'Decreto': 'DEC', 'DecLeg': 'DECLEG', 'Ato': 'Ato' };

        // Elementos DOM
        const yearSlider = document.getElementById('yearSlider');
        const yearDisplay = document.getElementById('yearDisplay');
        const numberInput = document.getElementById('projectNumber');
        const sliderMacro = document.getElementById('sliderMacro');
        const sliderMid = document.getElementById('sliderMid');
        const sliderMicro = document.getElementById('sliderMicro');
        const errorMsg = document.getElementById('errorMsg');
        
        // Elementos de UI Dinâmicos
        const tabProjetos = document.getElementById('tab-projetos');
        const tabNormas = document.getElementById('tab-normas');
        const typesProjetos = document.getElementById('types-projetos');
        const typesNormas = document.getElementById('types-normas');
        const actionsProjetos = document.getElementById('actions-projetos');
        const actionsNormas = document.getElementById('actions-normas');
        
        const labelMacro = document.getElementById('label-macro');
        const labelMicro = document.getElementById('label-micro');
        const maxMacroDisplay = document.getElementById('max-macro-display');
        const maxMicroDisplay = document.getElementById('max-micro-display');
        const containerMid = document.getElementById('container-mid');

        function init() {
            setMode('projetos'); // Inicializa no modo padrão

            // Listeners Sliders Número
            sliderMacro.addEventListener('input', updateFromSliders);
            sliderMid.addEventListener('input', updateFromSliders);
            sliderMicro.addEventListener('input', updateFromSliders);

            // Listener Ano
            yearSlider.addEventListener('input', (e) => {
                state.year = e.target.value;
                yearDisplay.innerText = state.year;
            });

            // Listener Input Manual
            numberInput.addEventListener('input', (e) => {
                let val = e.target.value.replace(/\D/g, '');
                const max = state.mode === 'projetos' ? CONFIG.projetos.maxNumber : CONFIG.normas.maxNumber;
                
                // Limite simples no input manual
                if (parseInt(val) > max) val = max.toString();
                
                e.target.value = val;
                state.number = val;

                if (val) {
                    syncSlidersFromNumber(val);
                    hideError();
                }
            });

            numberInput.addEventListener('blur', () => {
                if (!state.number) {
                    sliderMacro.value = 0;
                    sliderMid.value = 0;
                    sliderMicro.value = 0;
                }
            });
            
            numberInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    if(state.mode === 'projetos') openUrl('splegis');
                    else openUrl('plp');
                    numberInput.blur();
                }
            });
        }

        // --- Ajuste Granular de Ano (+/-) ---
        function adjustYear(delta) {
            let val = parseInt(state.year);
            const min = state.mode === 'projetos' ? CONFIG.projetos.minYear : CONFIG.normas.minYear;
            const max = CONFIG.maxYear;

            val += delta;

            if (val < min) val = min;
            if (val > max) val = max;

            state.year = val;
            yearSlider.value = val;
            yearDisplay.innerText = val;
        }

        // --- Nova Função: Ajuste Granular (Botões +/-) ---
        function adjustNumber(delta) {
            let val = parseInt(state.number || 0);
            const max = state.mode === 'projetos' ? CONFIG.projetos.maxNumber : CONFIG.normas.maxNumber;
            
            val += delta;
            
            if (val < 0) val = 0;
            if (val > max) val = max;
            
            state.number = val.toString();
            numberInput.value = val;
            
            if (val > 0) {
                syncSlidersFromNumber(val);
                hideError();
            } else {
                if (val === 0) {
                    // Mantém 0 visível, mas pode zerar sliders
                    syncSlidersFromNumber(0);
                }
            }
        }

        // --- Gestão de Modo (Projetos vs Normas) ---
        function setMode(mode) {
            state.mode = mode;
            const settings = CONFIG[mode];
            
            // 1. Atualizar Abas e Visibilidade
            if (mode === 'projetos') {
                toggleUI('projetos');
                selectType('PL'); 
            } else {
                toggleUI('normas');
                selectType('Lei');
            }

            // 2. Configurar Slider de Ano
            yearSlider.min = settings.minYear;
            yearSlider.max = CONFIG.maxYear;
            yearSlider.value = CONFIG.defaultYear;
            yearDisplay.innerText = CONFIG.defaultYear;
            state.year = CONFIG.defaultYear;
            // (Removido minYearLabel pois foi substituído pelos botões)

            // 3. Configurar Sliders de Número
            configureNumberSliders(mode);
            
            // 4. Resetar ou definir Padrão
            state.number = settings.defaultNumber;
            numberInput.value = state.number;
            
            if (state.number) {
                syncSlidersFromNumber(state.number);
                hideError();
            } else {
                sliderMacro.value = 0;
                sliderMid.value = 0;
                sliderMicro.value = 0;
            }
        }

        function toggleUI(activeMode) {
            const isProjetos = activeMode === 'projetos';
            
            // Abas
            tabProjetos.className = isProjetos ? tabProjetos.className.replace('mode-btn-inactive', 'mode-btn-active') : tabProjetos.className.replace('mode-btn-active', 'mode-btn-inactive');
            tabNormas.className = !isProjetos ? tabNormas.className.replace('mode-btn-inactive', 'mode-btn-active') : tabNormas.className.replace('mode-btn-active', 'mode-btn-inactive');
            
            // Paineis
            if (isProjetos) {
                typesProjetos.classList.remove('hidden');
                typesNormas.classList.add('hidden');
                actionsProjetos.classList.remove('hidden');
                actionsNormas.classList.add('hidden');
                containerMid.classList.add('hidden'); // Esconde 3º slider
            } else {
                typesNormas.classList.remove('hidden');
                typesProjetos.classList.add('hidden');
                actionsNormas.classList.remove('hidden');
                actionsProjetos.classList.add('hidden');
                containerMid.classList.remove('hidden'); // Mostra 3º slider
            }
        }

        function configureNumberSliders(mode) {
            const settings = CONFIG[mode];
            
            // Configurar Labels
            labelMacro.innerText = settings.macroLabel;
            maxMacroDisplay.innerText = settings.maxNumber;
            maxMicroDisplay.innerText = settings.microMax;

            // Range Macro
            // Projetos: 2000 / 100 = 20
            // Normas: 70000 / 1000 = 70
            const macroMax = Math.floor(settings.maxNumber / settings.macroStep);
            sliderMacro.max = macroMax;
            
            // Range Micro
            sliderMicro.max = settings.microMax;
            
            // Range Mid (Fixo 0-9 para centenas)
            // Se necessário, poderia vir do config, mas 0-9 * 100 cobre o intervalo
        }

        // --- Lógica de Slider Unificada ---
        function updateFromSliders() {
            const settings = CONFIG[state.mode];
            
            const macroVal = parseInt(sliderMacro.value);
            const microVal = parseInt(sliderMicro.value);
            
            let total = 0;

            if (settings.hasMid) {
                // Lógica de 3 níveis (Normas)
                // Total = (Macro * 1000) + (Mid * 100) + Micro
                const midVal = parseInt(sliderMid.value);
                total = (macroVal * 1000) + (midVal * 100) + microVal;
            } else {
                // Lógica de 2 níveis (Projetos)
                // Total = (Macro * 100) + Micro
                total = (macroVal * 100) + microVal;
            }
            
            // Cap (Limite Máximo)
            const finalVal = Math.min(total, settings.maxNumber);

            if (finalVal > 0) {
                state.number = finalVal.toString();
                numberInput.value = finalVal;
                hideError();
            } else {
                state.number = '';
                numberInput.value = '';
            }
        }

        function syncSlidersFromNumber(numStr) {
            const num = parseInt(numStr);
            if (isNaN(num)) return;

            const settings = CONFIG[state.mode];
            
            if (settings.hasMid) {
                // Decompor em 3 partes: 18452
                // Macro (Milhar): 18
                // Mid (Centena): 4
                // Micro (Unidade): 52
                const macro = Math.floor(num / 1000);
                const remainder = num % 1000;
                const mid = Math.floor(remainder / 100);
                const micro = remainder % 100;

                sliderMacro.value = macro;
                sliderMid.value = mid;
                sliderMicro.value = micro;

            } else {
                // Decompor em 2 partes
                const macro = Math.floor(num / settings.macroStep);
                const micro = num % settings.macroStep;
                
                sliderMacro.value = macro;
                sliderMicro.value = micro;
            }
        }

        // --- Seleção de Tipo ---
        function selectType(type) {
            state.type = type;
            
            // Atualizar UI de botões
            const group = state.mode === 'projetos' 
                ? ['PL', 'PDL', 'PR', 'PLO'] 
                : ['Lei', 'Decreto', 'DecLeg', 'Ato']; // Adicionado Ato ao grupo

            group.forEach(t => {
                const btn = document.getElementById(`btn-${t}`);
                if (!btn) return;
                
                if (t === state.type) {
                    btn.className = "type-btn active-type w-full py-3 rounded-lg font-bold text-sm border border-blue-600 bg-blue-600 text-white shadow-md transform scale-105 transition-all duration-200 touch-action-manipulation";
                    if(state.mode === 'normas') {
                         btn.className = btn.className.replace(/blue/g, 'purple');
                    }
                } else {
                    btn.className = "type-btn w-full py-3 rounded-lg font-bold text-sm border border-gray-200 bg-white text-gray-600 hover:bg-gray-50 touch-action-manipulation";
                }
            });
        }

        // --- Abrir URL ---
        function openUrl(destination) {
            if (!state.number || state.number === "0") {
                showError();
                numberInput.focus();
                return;
            }

            let url = '';
            
            if (state.mode === 'projetos') {
                if (destination === 'splegis') {
                    const code = spLegisCodes[state.type];
                    // Link atualizado para o novo formato do SPLegis
                    url = `https://splegisconsulta.saopaulo.sp.leg.br/Pesquisa/DetailsMateriaTramitacaoLegislativa?tipo=${code}&numero=${state.number}&ano=${state.year}`;
                } else {
                    const searchExpr = `${state.type}${state.number}${state.year}`;
                    url = `https://www.saopaulo.sp.leg.br/cgi-bin/wxis.bin/iah/scripts/?IsisScript=iah.xis&lang=pt&format=detalhado.pft&base=proje&form=A&nextAction=search&indexSearch=^nTw^lTodos%20os%20campos&exprSearch=P=${searchExpr}`;
                }
            } else {
                // Modo Normas (PLP)
                // Ex: https://app-plpconsulta-prd.azurewebsites.net/Forms/MostrarArquivo?TIPO=Lei&NUMERO=18378&ANO=2025&DOCUMENTO=Ficha
                const tipoCode = plpCodes[state.type];
                url = `https://app-plpconsulta-prd.azurewebsites.net/Forms/MostrarArquivo?TIPO=${tipoCode}&NUMERO=${state.number}&ANO=${state.year}&DOCUMENTO=Ficha`;
            }

            window.open(url, '_self');
        }

        function showError() {
            errorMsg.classList.remove('hidden');
            numberInput.classList.add('border-red-500', 'ring-2', 'ring-red-200');
            numberInput.classList.remove('border-gray-200');
        }

        function hideError() {
            errorMsg.classList.add('hidden');
            numberInput.classList.remove('border-red-500', 'ring-2', 'ring-red-200');
            numberInput.classList.add('border-gray-200');
        }

        init();
    </script>
</body>
</html>
